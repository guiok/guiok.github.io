---
title: "Medidas Correlacionadas"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Considere o modelo matemático abaixo para medição de uma resistência com base nos valores simultaneamente observados de corrente e voltagem sob condições ambientais idênticas, utilizando um voltímetro e um amperímetro (ambos os instrumentos estavam com escala selecionada visando a menor incerteza associada ao conjunto de medições em questão, ver Tabelas 2 e 3), considerando a influência de correlação entre as variáveis e tendo ciência de que a temperatura ambiente estava oscilando entre $22^oC$ e $26^oC$.

Modelo Matemático: 

* $R=\frac{(Va+Vr+Vc+Vt)}{(Ia+Ir+Ic+It)}$

| Fontes | Tipos | FDP | Parâmetros das FDP |
|--------------|:----:|:---:|:--------------:|
| $Va$ | A | Normal | Amostrado |
| $Vc$ | B | Normal | $\pm(0.5\%+3D)$ |
| $Vr$ | B | Uniforme | Display de 3 1/2 |
| $Vt$ | B | Uniforme | Válido entre $-10^{\circ}C$ e $40^{\circ}C$ |
| $Ia$ | A | Normal | Amostrado |
| $Ic$ | B | Normal | $\pm(1.2\%+4D)$ |
| $Ir$ | B | Uniforme | Display de 5 1/2 |
| $It$ | B | Uniforme | Válido entre $23^{\circ}C$ $\pm$ $5^{\circ}C$ |

```{r, message=FALSE, include=FALSE, cache=FALSE}
rm(list=ls())
library(isogum)
library(knitr)
library(xtable)
require(pracma)
library(latex2exp)
options(scipen = 999)
rm(list = setdiff(ls(), lsf.str()))
set.seed(11)
```

```{r, fig.fullwidth = TRUE}
val_v <- c(8.99, 9.01, 9.00, 8.99, 9.00, 9.01, 9.01, 8.98) #Volts
val_i <- c(20.658, 20.716, 20.698, 20.668, 20.692, 20.718, 20.704, 20.648)/1e3 #Amperes
```

```{r, message=FALSE, include=FALSE, cache=FALSE}
N <- length(val_v)

#V, ±(0.5%+3D), 3 1/2
m_v <- mean(val_v)
ava <- sd(val_v)/sqrt(N);
avc <- m_v*0.5/100+0.03
avr <- 0.01/2;

#A, ±(1.2%+4D), 5 1/2
m_i <- mean(val_i)
aia <- sd(val_i)/sqrt(N)
aic <- m_i*1.2/100+0.004/1E3
air <- 0.001/2/1E3

#Law of propagation of uncertainty (LPU)
lpu <- list()
lpu$n <- c("va", "vc", "vr", "ia", "ic", "ir")
lpu$s <- c("$v_a$", "$v_c$", "$v_r$", "$i_a$", "$i_c$", "$i_r$")
lpu$a <- c(ava, avc, avr, aia, aic, air)
lpu$d <- c(1, 2, sqrt(3), 1, 2, sqrt(3))
lpu$m <- c(m_v, 0, 0, m_i, 0, 0)
lpu$v <- c(N-1, Inf, Inf, N-1, Inf, Inf)
lpu$e <- quote((va+vc+vr)/(ia+ic+ir))
lpu$u <- lpu$a/lpu$d
lpu$unid <- "$\\Omega$"
lpu$p <- 0.99

#Monte Carlo simulation (MCS)
mcs <- list()
mcs$M <- round(10^4 / (1-lpu$p))
mcs$mc <- matrix(nrow=length(lpu$m), ncol=mcs$M)
mcs$mc[1,] <- rnorm(mcs$M, lpu$m[1], lpu$u[1]);
mcs$mc[2,] <- rnorm(mcs$M, lpu$m[2], lpu$u[2]);
mcs$mc[3,] <- runif(mcs$M, lpu$m[3]-lpu$a[3], lpu$m[3]+lpu$a[3]);
mcs$mc[4,] <- rnorm(mcs$M, lpu$m[4], lpu$u[4]);
mcs$mc[5,] <- rnorm(mcs$M, lpu$m[5], lpu$u[5]);
mcs$mc[6,] <- runif(mcs$M, lpu$m[6]-lpu$a[6], lpu$m[6]+lpu$a[6]);
``` 

## Cálculo Não Correlacionado

```{r, echo=FALSE, fig.fullwidth = TRUE}
#Cálculo sem considerar Correlação
r <- plot_GUM(lpu, mcs)
kable(r[2], digits=6, caption = "Law of propagation of uncertainty (LPU)")
kable(r[3], caption = "Monte Carlo simulation (MCS)")
```

## Cálculo LPU Correlacionado

```{r, message=FALSE, include=FALSE, cache=FALSE}
r_cor <- cor(val_v, val_i)
urc <- sum(r[[2]][5*8+1:6])^2 #coluna 6 linha 7 -> u_c(y)
cuva <- r[[2]][5*8+1] #coluna 6 linha 1 -> c(v_a)*u(v_a)
cuia <- r[[2]][5*8+4] #coluna 6 linha 4 -> c(i_a)*u(i_a)
rvi <- 2*cuva*cuia*r_cor
u_c <- sqrt(urc + rvi)
v_eff <- u_c^4/(cuva^4/(N-1)+cuia^4/(N-1))
v_eff <- trunc(v_eff)
t <- qt(1-(1-lpu$p)/2, v_eff)
u_exp <- u_c*t
res <- matrix(c(r_cor, u_c, v_eff, t, u_exp), byrow = TRUE)
rownames(res) <- c("$r(v,i)$", "$U_c(y)$", "$\\nu_{eff}$", "$t_{student}$", "$U_{exp}(y)$")
colnames(res) <- c("values")

AS1 <- paste("RM = ", format(round(m_v/m_i/1e3,digits=3), nsmall=3), "$\\pm$", signif(u_exp,digits=1)/1e3, "$k\\Omega$ com", lpu$p*100,"% de confiança\n")
AS2 <- paste("RM = ", format(round(m_v/m_i/1e3,digits=4), nsmall=4), "$\\pm$", signif(u_exp,digits=2)/1e3, "$k\\Omega$ com", lpu$p*100,"% de confiança\n")
df = data.frame(AS1,AS2)
colnames(df) <- c("1 Algarismo  Significativo", "2 Algarismos Significativos")
```

```{r, echo=FALSE, fig.fullwidth = TRUE}
kable(res)
kable(df)
```

## Cálculo MC Correlacionado

```{r, message=FALSE, include=FALSE, cache=FALSE}

Rx <- matrix(c(cor(val_v, val_v), cor(val_v, val_i),
               cor(val_i, val_v), cor(val_i, val_i)), 2, 2, byrow = T)
Dx <- diag(c(lpu$u[1], lpu$u[4]))
Ux <- Dx %*% Rx %*% Dx

R <- chol(Ux)
a <- dim(Ux)[1]
z <- matrix(rnorm(mcs$M*a),a)
xi <- t(R) %*% z
``` 

```{r, echo=FALSE, fig.fullwidth = TRUE}
par(mfrow=c(1,1))
plot(m_v+xi[1,], m_i+xi[2,], main ="Normal multivariada", xlab = "Volts", ylab = "Amperes")

par(mfrow=c(2,2))
hist(mcs$mc[1,], 100, main="Voltagem não-correlacionada", xlab = "volts")
hist(m_v+xi[1,], 100, main="Voltagem correlacionada", xlab = "volts")

hist(mcs$mc[4,], 100, main="Corrente não-correlacionada", xlab = "amperes")
hist(m_i+xi[2,], 100, main="Corrente correlacionada", xlab = "amperes")
```

```{r, message=FALSE, include=FALSE, cache=FALSE}
#Monte Carlo simulation (MCS)
mcs$mc[1,] <- m_v+xi[1,];
mcs$mc[4,] <- m_i+xi[2,];
```

```{r, echo=FALSE, fig.fullwidth = TRUE}
#Cálculo considerando a correlação
r <- plot_GUM(lpu, mcs, r2=rvi)
kable(r[3], caption = "Monte Carlo simulation (MCS)")
```
